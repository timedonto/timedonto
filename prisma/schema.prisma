generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
  output     = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================================
// ENUMS
// =====================================================================

enum UserRole {
  OWNER
  ADMIN
  DENTIST
  RECEPTIONIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELED
  RESCHEDULED
  NO_SHOW
  DONE
}

enum TreatmentPlanStatus {
  OPEN
  APPROVED
  REJECTED
}

enum PaymentMethod {
  CASH
  PIX
  CARD
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  PAST_DUE
}

enum InventoryMovementType {
  IN
  OUT
}

enum AttendanceStatus {
  CHECKED_IN
  IN_PROGRESS
  DONE
  CANCELED
  NO_SHOW
}

enum ClinicalDocumentType {
  ATESTADO
  PRESCRICAO
  EXAME
  ENCAMINHAMENTO
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// =====================================================================
// MODELS
// =====================================================================

model Clinic {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  dentists           Dentist[]
  patients           Patient[]
  appointments       Appointment[]
  records            Record[]
  treatmentPlans     TreatmentPlan[]
  payments           Payment[]
  subscription       Subscription?
  auditLogs          AuditLog[]
  inventoryItems     InventoryItem[]
  inventoryMovements InventoryMovement[]
  procedures         Procedure[]
  attendances        Attendance[]

  @@map("clinics")
}

model User {
  id           String   @id @default(cuid())
  clinicId     String
  name         String
  email        String
  passwordHash String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clinic             Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  dentist            Dentist?
  auditLogs          AuditLog[]
  inventoryMovements InventoryMovement[]
  attendances        Attendance[]

  @@unique([clinicId, email])
  @@index([clinicId])
  @@map("users")
}

model Dentist {
  id           String   @id @default(cuid())
  clinicId     String
  userId       String   @unique
  cro          String
  specialty    String? // @deprecated - Use dentistSpecialties relationship instead
  workingHours Json?
  bankInfo     Json?
  contactInfo  Json?
  personalInfo Json?
  commission   Decimal? @db.Decimal(5, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clinic               Clinic                @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments         Appointment[]
  records              Record[]
  treatmentPlans       TreatmentPlan[]
  dentistProcedures    DentistProcedure[]
  dentistSpecialties   DentistSpecialty[]
  attendances          Attendance[]
  attendanceCids       AttendanceCID[]
  attendanceProcedures AttendanceProcedure[]

  @@index([clinicId])
  @@map("dentists")
}

model Patient {
  id        String    @id @default(cuid())
  clinicId  String
  name      String
  email     String?
  phone     String?
  cpf       String?
  birthDate DateTime?
  address   String?
  notes     String?   @db.Text
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments   Appointment[]
  records        Record[]
  treatmentPlans TreatmentPlan[]
  payments       Payment[]
  attendances    Attendance[]

  @@index([clinicId])
  @@index([clinicId, name])
  @@index([clinicId, email])
  @@map("patients")
}

model Appointment {
  id                String            @id @default(cuid())
  clinicId          String
  dentistId         String
  patientId         String
  date              DateTime
  durationMinutes   Int               @default(30)
  status            AppointmentStatus @default(SCHEDULED)
  procedure         String? // @deprecated - mantido por compatibilidade
  procedureId       String? // FK para Procedure
  procedureSnapshot Json? // Snapshot: { name, baseValue, commissionPercentage }
  notes             String?           @db.Text
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  clinic             Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  dentist            Dentist             @relation(fields: [dentistId], references: [id], onDelete: Cascade)
  patient            Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  procedureRelation  Procedure?          @relation(fields: [procedureId], references: [id], onDelete: SetNull)
  record             Record?
  inventoryMovements InventoryMovement[]
  attendance         Attendance?

  @@index([clinicId])
  @@index([clinicId, date])
  @@index([clinicId, dentistId])
  @@index([clinicId, patientId])
  @@index([procedureId])
  @@map("appointments")
}

model Record {
  id            String   @id @default(cuid())
  clinicId      String
  patientId     String
  dentistId     String
  appointmentId String?  @unique
  attendanceId  String?  @unique
  description   String   @db.Text
  procedures    Json?
  odontogram    Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  dentist     Dentist      @relation(fields: [dentistId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  attendance  Attendance?  @relation(fields: [attendanceId], references: [id], onDelete: SetNull)

  @@index([clinicId])
  @@index([clinicId, patientId])
  @@index([attendanceId])
  @@map("records")
}

model TreatmentPlan {
  id           String              @id @default(cuid())
  clinicId     String
  patientId    String
  dentistId    String
  status       TreatmentPlanStatus @default(OPEN)
  totalAmount  Decimal             @db.Decimal(10, 2)
  discountType DiscountType?
  discountValue Decimal?            @db.Decimal(10, 2)
  finalAmount  Decimal?            @db.Decimal(10, 2)
  notes        String?             @db.Text
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  clinic                Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient               Patient                @relation(fields: [patientId], references: [id], onDelete: Cascade)
  dentist               Dentist                @relation(fields: [dentistId], references: [id], onDelete: Cascade)
  items                 TreatmentItem[]
  paymentTreatmentPlans PaymentTreatmentPlan[]

  @@index([clinicId])
  @@index([clinicId, patientId])
  @@index([clinicId, status])
  @@map("treatment_plans")
}

model TreatmentItem {
  id          String   @id @default(cuid())
  planId      String
  procedureId String?
  description String
  tooth       String?
  value       Decimal  @db.Decimal(10, 2)
  quantity    Int      @default(1)

  plan      TreatmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  procedure Procedure?   @relation(fields: [procedureId], references: [id], onDelete: SetNull)

  @@index([planId])
  @@index([procedureId])
  @@map("treatment_items")
}

model Payment {
  id            String        @id @default(cuid())
  clinicId      String
  patientId     String?
  originalAmount Decimal?      @db.Decimal(10, 2)
  discountType  DiscountType?
  discountValue Decimal?       @db.Decimal(10, 2)
  amount        Decimal       @db.Decimal(10, 2) // finalAmount - mantido como 'amount' para compatibilidade
  method        PaymentMethod
  description   String?
  createdAt     DateTime      @default(now())

  clinic                Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient               Patient?               @relation(fields: [patientId], references: [id], onDelete: SetNull)
  paymentTreatmentPlans PaymentTreatmentPlan[]

  @@index([clinicId])
  @@index([clinicId, createdAt])
  @@map("payments")
}

model PaymentTreatmentPlan {
  id              String   @id @default(cuid())
  paymentId       String
  treatmentPlanId String
  createdAt       DateTime @default(now())

  payment       Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  treatmentPlan TreatmentPlan @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)

  @@unique([paymentId, treatmentPlanId])
  @@index([paymentId])
  @@index([treatmentPlanId])
  @@map("payment_treatment_plans")
}

model Subscription {
  id                   String             @id @default(cuid())
  clinicId             String             @unique
  stripeCustomerId     String
  stripeSubscriptionId String
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model AuditLog {
  id         String   @id @default(cuid())
  clinicId   String
  userId     String
  action     String
  targetId   String?
  targetType String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([clinicId, userId])
  @@index([clinicId, action])
  @@index([clinicId, createdAt])
  @@map("audit_logs")
}

model InventoryItem {
  id              String   @id @default(cuid())
  clinicId        String
  name            String
  description     String?
  unit            String
  currentQuantity Int      @default(0)
  minQuantity     Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  clinic    Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  movements InventoryMovement[]

  @@index([clinicId])
  @@index([clinicId, name])
  @@map("inventory_items")
}

model InventoryMovement {
  id            String                @id @default(cuid())
  clinicId      String
  itemId        String
  type          InventoryMovementType
  quantity      Int
  appointmentId String?
  createdById   String
  notes         String?
  createdAt     DateTime              @default(now())

  clinic      Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  appointment Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  createdBy   User          @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([clinicId, itemId])
  @@index([clinicId, createdAt])
  @@map("inventory_movements")
}

model Specialty {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  procedures         Procedure[]
  dentistSpecialties DentistSpecialty[]

  @@map("specialties")
}

model CID {
  id          String   @id @default(cuid())
  code        String   @unique
  category    String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([category])
  @@map("cids")
}

model Procedure {
  id                   String   @id @default(cuid())
  clinicId             String
  specialtyId          String
  name                 String
  description          String?
  baseValue            Decimal  @db.Decimal(10, 2)
  commissionPercentage Decimal  @db.Decimal(5, 2)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  clinic               Clinic                @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  specialty            Specialty             @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  dentistProcedures    DentistProcedure[]
  appointments         Appointment[]
  attendanceProcedures AttendanceProcedure[]
  treatmentItems       TreatmentItem[]

  @@index([clinicId])
  @@index([specialtyId])
  @@index([clinicId, name])
  @@map("procedures")
}

model DentistProcedure {
  id          String   @id @default(cuid())
  dentistId   String
  procedureId String
  createdAt   DateTime @default(now())

  dentist   Dentist   @relation(fields: [dentistId], references: [id], onDelete: Cascade)
  procedure Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@unique([dentistId, procedureId])
  @@index([dentistId])
  @@index([procedureId])
  @@map("dentist_procedures")
}

model DentistSpecialty {
  id          String   @id @default(cuid())
  dentistId   String
  specialtyId String
  createdAt   DateTime @default(now())

  dentist   Dentist   @relation(fields: [dentistId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([dentistId, specialtyId])
  @@index([dentistId])
  @@index([specialtyId])
  @@map("dentist_specialties")
}

model Attendance {
  id            String           @id @default(cuid())
  clinicId      String
  appointmentId String?          @unique
  patientId     String
  dentistId     String?
  status        AttendanceStatus @default(CHECKED_IN)

  arrivalAt  DateTime
  startedAt  DateTime?
  finishedAt DateTime?

  createdByRole UserRole
  createdById   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  dentist     Dentist?     @relation(fields: [dentistId], references: [id], onDelete: SetNull)
  createdBy   User         @relation(fields: [createdById], references: [id], onDelete: Cascade)

  cids       AttendanceCID[]
  procedures AttendanceProcedure[]
  odontogram AttendanceOdontogram?
  documents  ClinicalDocument[]
  record     Record?

  @@index([clinicId])
  @@index([clinicId, status])
  @@index([clinicId, arrivalAt])
  @@index([clinicId, patientId])
  @@index([clinicId, dentistId])
  @@map("attendances")
}

model AttendanceCID {
  id                 String  @id @default(cuid())
  attendanceId       String
  cidCode            String
  description        String
  observation        String? @db.Text
  createdByDentistId String

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  createdBy  Dentist    @relation(fields: [createdByDentistId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([createdByDentistId])
  @@map("attendance_cids")
}

model AttendanceProcedure {
  id             String   @id @default(cuid())
  attendanceId   String
  procedureId    String? // FK para Procedure (nullable para compatibilidade)
  procedureCode  String? // @deprecated - manter por compatibilidade
  description    String
  tooth          String?
  surface        String? // @deprecated - usar faces
  faces          String[] // Array de faces: ["O", "M", "D", "V", "L"]
  quantity       Int      @default(1)
  clinicalStatus String? // Enum: SAUDAVEL, CARIE, RESTAURADO, AUSENTE, EM_TRATAMENTO, EXTRACAO
  price          Decimal? @db.Decimal(10, 2) // Preço no momento do registro
  dentistId      String? // FK para Dentist responsável
  observations   String?  @db.Text // Observações clínicas

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  procedure  Procedure? @relation(fields: [procedureId], references: [id], onDelete: SetNull)
  dentist    Dentist?   @relation(fields: [dentistId], references: [id], onDelete: SetNull)

  @@index([attendanceId])
  @@index([procedureId])
  @@index([dentistId])
  @@map("attendance_procedures")
}

model AttendanceOdontogram {
  attendanceId String @id
  data         Json

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@map("attendance_odontograms")
}

model ClinicalDocument {
  id           String               @id @default(cuid())
  attendanceId String
  type         ClinicalDocumentType
  payload      Json
  generatedBy  String
  generatedAt  DateTime             @default(now())

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([type])
  @@map("clinical_documents")
}
